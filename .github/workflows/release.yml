name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

jobs:
  format:
    name: Format
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
        toolchain: [stable]
    runs-on: ${{ matrix.platform.runner }}
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.toolchain }}
          components: rustfmt, clippy

      - name: Run format
        run: cargo fmt --all -- --check

  test:
    name: Test
    needs: [format]
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - runner: macos-latest
            target: aarch64-apple-darwin
          - runner: macos-15-intel
            target: x86_64-apple-darwin
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
          - runner: windows-latest
            target: aarch64-pc-windows-msvc
            skip_test_run: true
        toolchain: [stable]
    runs-on: ${{ matrix.platform.runner }}
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.toolchain }}
          target: ${{ matrix.platform.target }}
          components: rustfmt, clippy

       - name: Run test
        run: cargo test --target "${{ matrix.platform.target }}" --all-features ${{ matrix.platform.skip_test_run == true && '--no-run' || '' }}

  test-python:
    name: Test Python
    needs: [format]
    runs-on: ubuntu-latest
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - name: Run Python test
        shell: bash
        run: |
          make init
          make python-test

  test-wasm:
    name: Test WASM
    needs: [format]
    runs-on: ubuntu-latest
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Run WASM test
        run: make wasm-test

  create-release:
    name: Create Release
    needs: [test, test-python, test-wasm]
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true

  build-dictionary:
    name: Build Dictionary
    needs: [create-release]
    strategy:
      matrix:
        dictionary:
          - name: "lindera-ipadic"
            feature: "embed-ipadic"
          - name: "lindera-unidic"
            feature: "embed-unidic"
          - name: "lindera-ko-dic"
            feature: "embed-ko-dic"
          - name: "lindera-cc-cedict"
            feature: "embed-cc-cedict"
          - name: "lindera-ipadic-neologd"
            feature: "embed-ipadic-neologd"
    runs-on: ubuntu-latest
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build dictionary
        run: |
          LINDERA_DICTIONARIES_PATH=dictionaries cargo build -p ${{ matrix.dictionary.name }} --features ${{ matrix.dictionary.feature }}

      - name: Get version
        id: get_version
        run: |
          VERSION=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[] | select(.name=="${{ matrix.dictionary.name }}") | .version')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create artifact
        run: |
          cd dictionaries/${{ steps.get_version.outputs.version }}
          zip -r ../../${{ matrix.dictionary.name }}-${{ steps.get_version.outputs.version }}.zip ${{ matrix.dictionary.name }}

      - name: Upload artifact
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ matrix.dictionary.name }}-${{ steps.get_version.outputs.version }}.zip
          tag_name: ${{ github.ref_name }}

      - name: Upload dictionary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.dictionary.name }}
          path: dictionaries/

  build:
    name: Build
    needs: [create-release, build-dictionary]
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: .zip
            extension: ""
          - runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            archive: .zip
            extension: ""
          - runner: macos-latest
            target: aarch64-apple-darwin
            archive: .zip
            extension: ""
          - runner: macos-15-intel
            target: x86_64-apple-darwin
            archive: .zip
            extension: ""
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            archive: .zip
            extension: .exe
          - runner: windows-latest
            target: aarch64-pc-windows-msvc
            archive: .zip
            extension: .exe
        toolchain: [stable]
        features:
          - value: "default"
            package_name: "lindera"
            package_description: "Lindera (no dictionary)"
          - value: "embed-ipadic"
            package_name: "lindera-ipadic"
            package_description: "Lindera with Japanese dictionary (IPADIC)"
          - value: "embed-ipadic-neologd"
            package_name: "lindera-ipadic-neologd"
            package_description: "Lindera with Japanese dictionary (IPADIC-NEologd)"
          - value: "embed-unidic"
            package_name: "lindera-unidic"
            package_description: "Lindera with Japanese dictionary (UniDic)"
          - value: "embed-ko-dic"
            package_name: "lindera-ko-dic"
            package_description: "Lindera with Korean dictionary (ko-dic)"
          - value: "embed-cc-cedict"
            package_name: "lindera-cc-cedict"
            package_description: "Lindera with Chinese dictionary (CC-CEDICT)"
          - value: "embed-cjk"
            package_name: "lindera-cjk"
            package_description: "Lindera with CJK dictionaries (IPADIC, ko-dic, CC-CEDICT)"
          - value: "embed-cjk2"
            package_name: "lindera-cjk2"
            package_description: "Lindera with CJK dictionaries (UniDic, ko-dic, CC-CEDICT)"
          - value: "embed-cjk3"
            package_name: "lindera-cjk3"
            package_description: "Lindera with CJK dictionaries (IPADIC NEologd, ko-dic, CC-CEDICT)"

    runs-on: ${{ matrix.platform.runner }}
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Cache ~/.cargo/registry
        uses: actions/cache@v5
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache ~/.cargo/git
        uses: actions/cache@v5
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ matrix.toolchain }}
          target: ${{ matrix.platform.target }}

      - name: Add msbuild to PATH
        if: startsWith(matrix.platform.runner, 'windows')
        uses: microsoft/setup-msbuild@v2

      - name: Download dictionary artifacts
        uses: actions/download-artifact@v7
        with:
          path: dictionaries
          pattern: lindera-*
          merge-multiple: true

      - name: Compile
        run: cargo build --release --features="${{ matrix.features.value }},compress" --target=${{ matrix.platform.target }} --target-dir=target/${{ matrix.features.value }}
        env:
          LINDERA_DICTIONARIES_PATH: dictionaries

      - name: Create artifact for Linux
        if: startsWith(matrix.platform.runner, 'ubuntu')
        run: zip --junk-paths ${{ matrix.features.package_name }}-${{ matrix.platform.target }}-${{ github.ref_name }}${{ matrix.platform.archive }} target/${{ matrix.features.value }}/${{ matrix.platform.target }}/release/lindera${{ matrix.platform.extension }}

      - name: Create artifact for Windows
        if: startsWith(matrix.platform.runner, 'windows')
        run: powershell Compress-Archive -DestinationPath ${{ matrix.features.package_name }}-${{ matrix.platform.target }}-${{ github.ref_name }}${{ matrix.platform.archive }} -Path target/${{ matrix.features.value }}/${{ matrix.platform.target }}/release/lindera${{ matrix.platform.extension }}

      - name: Create artifact for macOS
        if: startsWith(matrix.platform.runner, 'macos')
        run: zip --junk-paths ${{ matrix.features.package_name }}-${{ matrix.platform.target }}-${{ github.ref_name }}${{ matrix.platform.archive }} target/${{ matrix.features.value }}/${{ matrix.platform.target }}/release/lindera${{ matrix.platform.extension }}

      - name: Upload artifact
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ matrix.features.package_name }}-${{ matrix.platform.target }}-${{ github.ref_name }}${{ matrix.platform.archive }}
          tag_name: ${{ github.ref_name }}

  publish-crates:
    name: Publish crates
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Publish crates
        run: |
          for crate in lindera-dictionary lindera-cc-cedict lindera-ipadic lindera-ipadic-neologd lindera-ko-dic lindera-unidic lindera lindera-python lindera-cli lindera-wasm; do
            VERSION=$(cargo metadata --no-deps --format-version=1 | jq -r ".packages[] | select(.name==\"$crate\") | .version")
            PUBLISHED_VERSIONS=$(curl -s -A "lindera-release-workflow (https://github.com/lindera/lindera)" "https://crates.io/api/v1/crates/$crate" | jq -r 'select(.versions != null) | .versions[].num')
            if echo "${PUBLISHED_VERSIONS}" | grep -Fx "${VERSION}" >/dev/null; then
              echo "$crate $VERSION has already published"
            else
              echo "Publishing $crate $VERSION..."
              pushd $crate
              cargo publish
              popd
              sleep 20
            fi
          done
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_TOKEN }}

  build-python-wheels:
    name: Build wheels for ${{ matrix.platform.target }}
    needs: [create-release]
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
          - runner: windows-latest
            target: aarch64-pc-windows-msvc
          - runner: macos-latest
            target: aarch64-apple-darwin
          - runner: macos-15-intel
            target: x86_64-apple-darwin
        features:
          - value: "default"
            package_name: "lindera-python"
            package_description: "Python binding for Lindera (no embedded dictionaries)"
          - value: "embed-cjk"
            package_name: "lindera-python-cjk"
            package_description: "Python binding for Lindera with CJK dictionaries (IPADIC, ko-dic, CC-CEDICT)"
          - value: "embed-ipadic"
            package_name: "lindera-python-ipadic"
            package_description: "Python binding for Lindera with IPADIC dictionary"
          - value: "embed-unidic"
            package_name: "lindera-python-unidic"
            package_description: "Python binding for Lindera with UniDic dictionary"
          - value: "embed-ko-dic"
            package_name: "lindera-python-ko-dic"
            package_description: "Python binding for Lindera with ko-dic Korean dictionary"
          - value: "embed-cc-cedict"
            package_name: "lindera-python-cc-cedict"
            package_description: "Python binding for Lindera with CC-CEDICT Chinese dictionary"
    runs-on: ${{ matrix.platform.runner }}
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.x

      - name: Create package-specific pyproject.toml
        shell: bash
        run: |
          python -c "
          import sys
          import re
          path = 'lindera-python/pyproject.toml'
          with open(path, 'r') as f:
              content = f.read()
          content = re.sub(r'^name = \"lindera-python\"', 'name = \"${{ matrix.features.package_name }}\"', content, flags=re.MULTILINE)
          content = re.sub(r'^description = \".*\"', 'description = \"${{ matrix.features.package_description }}\"', content, flags=re.MULTILINE)
          with open(path, 'w') as f:
              f.write(content)
          "

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter --features=${{ matrix.features.value }} --manifest-path lindera-python/Cargo.toml
          sccache: "true"
          manylinux: auto
          before-script-linux: |
            if command -v yum >/dev/null 2>&1; then
              yum install openssl-devel devtoolset-10-libatomic-devel perl-IPC-Cmd -y
            elif command -v apt-get >/dev/null 2>&1; then
              apt-get update && apt-get install libssl-dev pkg-config -y
            fi

      - name: Upload artifact
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: dist/*
          tag_name: ${{ github.ref_name }}

      - name: Upload to workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.features.package_name }}-${{ runner.os }}-${{ matrix.platform.target }}-${{ github.ref_name }}
          path: dist

  build-python-sdist:
    name: Build sdist for ${{ matrix.features.package_name }}
    needs: [create-release]
    strategy:
      matrix:
        features:
          - value: "default"
            package_name: "lindera-python"
            package_description: "Python binding for Lindera (no embedded dictionaries)"
          - value: "embed-cjk"
            package_name: "lindera-python-cjk"
            package_description: "Python binding for Lindera with CJK dictionaries (IPADIC, ko-dic, CC-CEDICT)"
          - value: "embed-ipadic"
            package_name: "lindera-python-ipadic"
            package_description: "Python binding for Lindera with IPADIC dictionary"
          - value: "embed-unidic"
            package_name: "lindera-python-unidic"
            package_description: "Python binding for Lindera with UniDic dictionary"
          - value: "embed-ko-dic"
            package_name: "lindera-python-ko-dic"
            package_description: "Python binding for Lindera with ko-dic Korean dictionary"
          - value: "embed-cc-cedict"
            package_name: "lindera-python-cc-cedict"
            package_description: "Python binding for Lindera with CC-CEDICT Chinese dictionary"
    runs-on: ubuntu-latest
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Create package-specific pyproject.toml
        shell: bash
        run: |
          python -c "
          import sys
          import re
          path = 'lindera-python/pyproject.toml'
          with open(path, 'r') as f:
              content = f.read()
          content = re.sub(r'^name = \"lindera-python\"', 'name = \"${{ matrix.features.package_name }}\"', content, flags=re.MULTILINE)
          content = re.sub(r'^description = \".*\"', 'description = \"${{ matrix.features.package_description }}\"', content, flags=re.MULTILINE)
          with open(path, 'w') as f:
              f.write(content)
          "

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist --manifest-path lindera-python/Cargo.toml

      - name: Upload artifact
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: dist/*
          tag_name: ${{ github.ref_name }}

      - name: Upload to workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdist-${{ matrix.features.package_name }}-${{ github.ref_name }}
          path: dist

  publish-pypi:
    name: Publish to PyPI
    needs: [build-python-wheels, build-python-sdist]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    permissions:
      id-token: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*

  build-wasm:
    name: Build WASM
    needs: [publish-crates]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    strategy:
      matrix:
        features:
          - value: ""
            package_name: "lindera-wasm"
          - value: "embed-ipadic"
            package_name: "lindera-wasm-ipadic"
          - value: "embed-unidic"
            package_name: "lindera-wasm-unidic"
          - value: "embed-ko-dic"
            package_name: "lindera-wasm-ko-dic"
          - value: "embed-cc-cedict"
            package_name: "lindera-wasm-cc-cedict"
          - value: "embed-cjk"
            package_name: "lindera-wasm-cjk"
    steps:
      - name: Run checkout
        uses: actions/checkout@v6

      - name: Install toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Update package name and build
        shell: bash
        run: |
          sed -i 's/^name = "lindera-wasm"$/name = "${{ matrix.features.package_name }}"/' lindera-wasm/Cargo.toml
          cd lindera-wasm
          wasm-pack build --release --target web ${{ matrix.features.value != '' && format('--features {0}', matrix.features.value) || '' }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasm-pkg-${{ matrix.features.package_name }}
          path: lindera-wasm/pkg

  publish-npm:
    name: Publish to npm
    needs: [build-wasm]
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    strategy:
      matrix:
        features:
          - value: ""
            package_name: "lindera-wasm"
          - value: "embed-ipadic"
            package_name: "lindera-wasm-ipadic"
          - value: "embed-unidic"
            package_name: "lindera-wasm-unidic"
          - value: "embed-ko-dic"
            package_name: "lindera-wasm-ko-dic"
          - value: "embed-cc-cedict"
            package_name: "lindera-wasm-cc-cedict"
          - value: "embed-cjk"
            package_name: "lindera-wasm-cjk"
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: wasm-pkg-${{ matrix.features.package_name }}
          path: lindera-wasm/pkg

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        run: |
          cd lindera-wasm/pkg
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
